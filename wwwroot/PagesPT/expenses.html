<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Lista  de Despesas</title>

    <link href="../DataTables/datatables.css" rel="stylesheet" />
    <link href="../DataTables/buttons.dataTables.css" rel="stylesheet" />
    <link href="../DataTables/select.dataTables.css" rel="stylesheet" />
    <link href="../DataTables/dataTables.dateTime.min.css" rel="stylesheet" />
    <link href="../DataTables/fixedHeader.dataTables.min.css" rel="stylesheet">
    <link href="../DataTables/stateRestore.dataTables.min.css" rel="stylesheet">
    <link href="../app.css" rel="stylesheet" />

    <style type="text/css" class="init">
           table {
               table-layout: fixed;
           }
           /*  .container {
            margin-left: 10px;
        }*/
           .plus-button {
               background-color: #007BFF;
               color: white;
               border: none;
               padding: 10px 18px;
               border-radius: 12px;
               font-size: 20px;
               cursor: pointer;
               box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
               transition: background-color 0.3s ease, transform 0.2s ease;
           }

               .plus-button:hover {
                   background-color: #0056b3; /* darker blue */
                   transform: scale(1.05); /* slightly grow */
               }

           /*  html, body, table, input, select, button {
            font-family: 'Inter', 'Segoe UI', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            font-size: 14px;
            color: #333;
        }*/


    </style>



    <script src="../DataTables/jquery-3.7.1.min.js"></script>
    <script src="../DataTables/datatables.js"></script>
    <script src="../DataTables/dataTables.buttons.js"></script>
    <script src="../DataTables/buttons.dataTables.js"></script>
    <script src="../DataTables/dataTables.select.js"></script>
    <script src="../DataTables/select.dataTables.js"></script>
    <script src="../DataTables/dataTables.dateTime.min.js"></script>
    <script src="../DataTables/moment.min.js"></script>
    <script src="../DataTables/datetime-moment.js"></script>
    <script src="../DataTables/dataTables.fixedHeader.min.js"></script>
    <script src="../DataTables/jszip.min.js"></script>
    <script src="../DataTables/pdfmake.min.js"></script>
    <script src="../DataTables/vfs_fonts.js"></script>
    <script src="../DataTables/buttons.html5.min.js"></script>
    <script src="../DataTables/buttons.print.min.js"></script>



    <script type="text/javascript">


        $(document).ready(function () {

            //Name drop menu populate - EditModal
            fetch('/api/getexpensesID')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('expenseNameID');
                    data.forEach(expense => {
                        const option = document.createElement('option');
                        option.value = expense.id;
                        option.textContent = expense.despesa;
                        select.appendChild(option);
                    });
                })
                .catch(error => console.error('Error loading expenses:', error));

            var table = new DataTable('#mainGrid', {
                "lengthMenu": [10, 25, 50, 100, { label: 'All', value: -1 }],
                "pageLength": 10,
                "fixedHeader": {
                    footer: true
                },
                initComplete: function () {

                    // Create Column drop menu filter
                    var columnWidths = { 0: 60, 4:60 };
                    createColumnFilterDropdowns(table, columnWidths, 1);


                    var minDate, maxDate;

                    //Custom filtering function which will search data
                    //in column 1 between two values - 0 index columns
                    DataTable.ext.search.push(function (settings, data, dataIndex) {
                        var min = minDate.val();
                        var max = maxDate.val();
                        var date = new Date(data[1]); //Date column date search

                        if (
                            (min === null && max === null) ||
                            (min === null && date <= max) ||
                            (min <= date && max === null) ||
                            (min <= date && date <= max)
                        ) {
                            return true;
                        }
                        return false;
                    });

                    //Create date inputs
                    minDate = new DateTime('#txtdatestart', {
                        format: 'MMMM Do YYYY'
                    });
                    maxDate = new DateTime('#txtdateend', {
                        format: 'MMMM Do YYYY'
                    });


                    //Refilter the table
                    $('#txtdatestart, #txtdateend').on('change', function () {
                        if ($("#txtdatestart").val() == "") {

                            minDate.val(null);
                        }
                        if ($("#txtdateend").val() == "") {

                            maxDate.val(null);

                        }
                        //Search and draw
                        table.search()
                        table.draw();
                    });

                    //Clear filters
                    $('#clearDates').on('click', () => {
                        // Clear date input values
                        $("#txtdatestart, #txtdateend").val("");
                        //Set those null as well
                        minDate.val(null)
                        maxDate.val(null)
                        table.draw();
                    });


                    //Row Clicking Event
                    $('#mainGrid tbody').on('click', 'tr', function () {

                        //Capture row data
                        const rowdata = table.row(this).data();

                        // Store it globally for the edit/delete button to use.
                        //eventBeingEdited is a custom property created
                        window.eventBeingEdited = rowdata;
                    });

                },

                layout: {
                    topStart: {
                        buttons: ['copy', 'csv', 'excel', 'pdf', 'print', 'pageLength']
                    }
                },


                "ajax": {
                    url: '/api/expenses',
                    type: "GET",
                    dataSrc: ''
                },

                order: [[1, 'desc']],
                //columnDefs: [

                //    { targets: [2, 10, 11], width: '650px', className: 'dt-center'},
                //    ],
                "columns": [
                    { "data": 'expense.despesa', 'width': '100px', visible: true },
                    { "data": 'date', 'width': '80px', visible: true },
                    { "data": 'notes', 'width': '150px', visible: true },
                    {
                        "data": 'amount', 'width': '90px',
                        render: DataTable.render.number(null, null, 2, '$')
                    },
                    {
                        "data": 'paid', 'width': '60px', visible: true,
                        "render": function (data, type, row, meta) {
                            if (data == 'Yes') {
                                data = 'Sim';
                            }
                            else {
                                data = 'Nao';
                            }
                            return data;
                        }
                    },
                    {
                        "data": null, 'width': '50px',
                        "render": function (data, type, row, meta) {
                            if (type === 'display') {
                                data = '<a href="#" onclick="document.getElementById(\'editDeleteModal\').style.display=\'block\'">Modificar</a>';
                            }

                            return data;
                        }
                    },
                  
                ],
            });

            // Delete Event
            document.getElementById('deleteexpenseBtn').addEventListener('click', function () {
                if (window.eventBeingEdited) {
                    //From row clicking
                    const data = window.eventBeingEdited;
                    const expenseid = data.id;

                    fetch(`/api/expenses/${expenseid}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ id: expenseid })
                    })
                        .then(response => {
                            if (!response.ok) throw new Error('Delete failed');



                            window.eventBeingEdited = null;
                            document.getElementById('editDeleteModal').style.display = 'none';
                            $('#mainGrid').DataTable().ajax.reload();

                            // Show success message
                            const msg = document.getElementById('successMessageDeleted');
                            msg.style.display = 'block';

                            // Hide after 3 seconds
                            setTimeout(() => {
                                msg.style.display = 'none';
                            }, 3000);


                        })
                        .catch(error => console.error('Error deleting expense:', error));
                }
            });

            // Edit
            document.getElementById('editexpenseBtn').addEventListener('click', function () {

                //From row clicking
                const data = window.eventBeingEdited;

                if (window.eventBeingEdited) {
                    document.getElementById('expenseID').value = data.id;
                    document.getElementById('expenseNameID').value = data.expense.id;
                    document.getElementById('expenseDate').value = data.date;
                    document.getElementById('expenseNotes').value = data.notes;
                    document.getElementById('expensePaid').value = (data.paid || '').trim();
                    document.getElementById('expenseAmount').value = data.amount ?? 0;


                    document.getElementById('editDeleteModal').style.display = 'none';
                    document.getElementById('ExpenseModal').style.display = 'block';


                }
            });

            //Save modifications
            document.getElementById('saveExpenseBtn').addEventListener('click', function () {

                const id = document.getElementById('expenseID').value;
                const expenseID = document.getElementById('expenseNameID').value;
                const date = document.getElementById('expenseDate').value || null;
                const notes = document.getElementById('expenseNotes').value || null;
                const paid = document.getElementById('expensePaid').value || 'No';
                const amount = document.getElementById('expenseAmount').value || 0;

                if (!expenseID) {
                    const msg = `Despesa deve ser selecionada`;
                    document.getElementById('modalMessage').textContent = msg;
                    document.getElementById('modalMessage').style.color = 'red';
                    return;
                }


                if (window.eventBeingEdited) {
                    // UPDATE existing event
                    const event = window.eventBeingEdited;

                    const updatedexpense = {
                        id: id,
                        ExpenseID: expenseID,
                        Date: date,
                        Notes: notes,
                        Paid: paid,
                        Amount: amount,
                    };

                    fetch(`/api/expenses`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updatedexpense)
                    })
                        .then(response => {
                            if (!response.ok) throw new Error("Update failed");

                            window.eventBeingEdited = null;
                            document.getElementById('ExpenseModal').style.display = 'none';
                            document.getElementById('modalMessage').textContent = '';
                            // Show success message
                            const msg = document.getElementById('successMessageSaved');
                            msg.style.display = 'block';

                            // Hide after 3 seconds
                            setTimeout(() => {
                                msg.style.display = 'none';
                            }, 3000);

                            $('#mainGrid').DataTable().ajax.reload();
                            table.draw();
                        })
                        .catch(error => console.error('Error updating expense:', error));
                }
                else {
                    // ADD new expense
                    const newexpense = {
                       // id: id,
                        ExpenseID: expenseID,
                        Date: date,
                        Notes: notes,
                        Paid: paid,
                        Amount: amount,
                    };

                    fetch('/api/expenses', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(newexpense)
                    })
                        .then(async response => {
                            const text = await response.text();  //
                            if (!response.ok) {
                                throw new Error(text.trim());    //
                            }
                            return JSON.parse(text);
                        })
                        .then(data => {
                            // Close modal
                            document.getElementById('ExpenseModal').style.display = 'none';

                            // Reload table
                            $('#mainGrid').DataTable().ajax.reload();
                            table.draw();

                            // Reset form inputs
                            document.getElementById('expenseID').value = '';
                            document.getElementById('expenseNameID').value = '';
                            document.getElementById('expenseDate').value = '';
                            document.getElementById('expenseNotes').value = '';
                            document.getElementById('expensePaid').value = '';
                            document.getElementById('expenseAmount').value = '';

                            // Show success message
                            const msg = document.getElementById('successMessageSaved');
                            msg.style.display = 'block';

                            // Hide after 3 seconds
                            setTimeout(() => {
                                msg.style.display = 'none';
                            }, 3000);
                        })
                        .catch(error => {
                            console.error('Error saving event:', error);
                            document.getElementById('modalMessage').textContent = error.message;
                            document.getElementById('modalMessage').style.color = 'red';
                        });
                }  //

            });  // closing save


        });

        //Create Column Drop Filters Function
        function createColumnFilterDropdowns(table, columnWidths, row) {
            table.columns(Object.keys(columnWidths))
                .every(function () {
                    var column = this;
                    var index = column.index();
                    var width = columnWidths[index] || 60;

                    // Create select element and listener
                    var select = $('<select class="column_search" id="col'
                        + index + '"><option value=""></option></select>')
                        .css('width', width) // Apply specified width
                        .appendTo($("#mainGrid thead tr:eq(" + row + ") th")
                            .eq(index).empty()) // Add to row of the table header
                        .on('change', function () {
                            column
                                .search($(this).find('option:selected').text(), { exact: true })
                                .draw();
                            console.info($(this).find('option:selected').text());
                        });
                    if (index == 4) {
                       
                        select.append('<option value="Yes">Sim</option>');
                        select.append('<option value="No">Nao</option>');
                    }
                    else {
                        // Populate the select with unique column values
                        column
                            .data()
                            .unique()
                            .sort()
                            .each(function (d) {
                                select.append('<option value="' + d + '">'
                                    + d + '</option>');
                            });
                    }
                });
        }

    </script>
</head>
<body>

    <h1>Despesas</h1>


    <div class="container" style="margin-top: 20px;">
        <button class="plus-button" onclick="window.eventBeingEdited = null;
        document.getElementById('ExpenseModal').style.display = 'block';
        document.getElementById('modalMessage').textContent = '';
        // Reset form inputs
        document.getElementById('expenseID').value = '';
        document.getElementById('expenseNameID').value = '';
        document.getElementById('expenseDate').value = '';
        document.getElementById('expenseNotes').value = '';
        document.getElementById('expensePaid').value = '';
        document.getElementById('expenseAmount').value = '';">
            + Adicionar Despesa
        </button>
    </div>

    <div style="margin-bottom: 20px; margin-top: 20px; display: flex; gap: 20px; align-items: flex-end;">
        <div>
            <label for="txtdatestart">Data Inicio:</label><br />
            <input type="text" id="txtdatestart" />
        </div>
        <div>
            <label for="txtdateend">Data Fim:</label><br />
            <input type="text" id="txtdateend" />
        </div>
        <div>
            <button type="button" id="clearDates" style="margin-right: 10px;">Limpar Datas</button>
        </div>

    </div>


    <div class="container" style="margin-top: 20px;">
        <!--Grid declaration-->
        <table id="mainGrid" class="display" style="width:100%">
            <thead>
                <tr>
                    <th>Despesa</th>
                    <th>Data</th>
                    <th>Notas</th>
                    <th>Montante</th>
                    <th>Pago</th>
                    <th></th>
                </tr>
                <tr>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
            <tfoot>
                <tr>
                    <th>Despesa</th>
                    <th>Data</th>
                    <th>Notas</th>
                    <th>Montante</th>
                    <th>Pago</th>
                    <th></th>
                </tr>
            </tfoot>
        </table>
    </div>

    <!-- Edit/Delete Modal -->
    <div id="editDeleteModal" style="display:none; position:fixed; top:5%; left:50%; transform:translate(-50%, -20%); background:#fff; border:1px solid #ccc; padding:20px; box-shadow:0 2px 10px rgba(0,0,0,0.2); z-index:1000;">
        <h3>Editar Despesa</h3>
        <!--<p id="selectedEventTitle" style="font-weight:bold;"></p>-->
        <button id="editexpenseBtn">Editar</button>
        <button id="deleteexpenseBtn">Excluir</button>
        <button onclick="document.getElementById('editDeleteModal').style.display='none'">Cancelar</button>
    </div>

    <!-- Modal -->
    <div id="ExpenseModal" style="display:none; position:fixed; top:1%; left:50%; transform:translate(-50%, -1%); background:#fff; border:1px solid #ccc; padding:20px; box-shadow:0 2px 10px rgba(0,0,0,0.2); z-index:1000;">
        <h3>Info Despesa</h3>

        <label>Despesa:</label><br>
        <select id="expenseNameID" style="width:100%;">
            <option value="">-- Selecione a despesa --</option>
        </select><br><br>

        <label>Data:</label><br>
        <input type="date" id="expenseDate" style="width:100%;"><br><br>

        <label>Pago:</label><br>
        <select id="expensePaid" style="width:100%;">
            <option value="">-- Pago --</option>
            <option value="No">Nao</option>
            <option value="Yes">Sim</option>
        </select><br><br>

        <label>Notas:</label><br>
        <textarea type="text" id="expenseNotes" rows="10" style="width:100%;"></textarea><br><br>

        <label>Montante $:</label><br>
        <input type="number" id="expenseAmount" step="0.01" min="0" required /><br><br>


        <input type="hidden" id="expenseID" style="width:100%;" /><br><br>


        <p id="modalMessage" style="font-weight: bold;"></p>

        <button id="saveExpenseBtn">Salvar</button>
        <button onclick="document.getElementById('ExpenseModal').style.display = 'none'">Cancelar</button>
    </div>

    <div id="successMessageSaved" style="
       display: none;
       background-color: #d4edda;
       color: #155724;
       padding: 10px 20px;
       border-radius: 6px;
       margin-top: 10px;
       box-shadow: 0 2px 4px rgba(0,0,0,0.1);
       font-weight: bold;
       ">
        Despesa salva com sucesso!
    </div>

    <div id="successMessageDeleted" style="
    display: none;
    background-color: #d4edda;
    color: #155724;
    padding: 10px 20px;
    border-radius: 6px;
    margin-top: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    font-weight: bold;
    ">
        Despesa Excluida com sucesso!
    </div>


</body>
</html>